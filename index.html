<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Katana by Shogun147</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Katana</h1>
        <h2>Easy to use, modular web framework for any Node.js samurai</h2>
        <a href="https://github.com/Shogun147/Katana" class="button"><small>View project on</small>GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <p><a href="https://github.com/Shogun147/Katana"><img src="https://raw.github.com/Shogun147/Katana/master/katana.jpg"></a></p>

<p>Easy to use, modular web framework for any Node.js samurai, focuses on simplicity, maintainability and performance.</p>

<h2>
<a name="contents" class="anchor" href="#contents"><span class="octicon octicon-link"></span></a>Contents</h2>

<ul>
<li><a href="#features">Features</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#quick-start">Quick start</a></li>
<li><a href="#routing">Routing</a></li>
<li><a href="#modules">Modules</a></li>
<li>
<a href="#controllers">Controllers</a>

<ul>
<li><a href="#hooks">Hooks</a></li>
</ul>
</li>
<li><a href="#models">Models</a></li>
<li><a href="#views">Views</a></li>
<li><a href="#events">Events</a></li>
<li><a href="#sessions">Sessions</a></li>
<li><a href="#logging">Logging</a></li>
<li><a href="#examples">Examples</a></li>
<li><a href="#contributing">Contributing</a></li>
<li><a href="#license">License</a></li>
</ul><h2>
<a name="features" class="anchor" href="#features"><span class="octicon octicon-link"></span></a>Features</h2>

<ul>
<li>Powerful, flexible classical router</li>
<li>Scalable through HMVC architecture </li>
<li>Environment based configuration</li>
<li>Application quick generators</li>
<li>Cookies and Session support</li>
<li>Templating, partials support</li>
<li>Fully non-blocking</li>
<li>…</li>
</ul><h2>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>Fastest way to get Katana is to install it with NPM:</p>

<div class="highlight"><pre><span class="nv">$ </span>npm install -g katana
</pre></div>

<h2>
<a name="quick-start" class="anchor" href="#quick-start"><span class="octicon octicon-link"></span></a>Quick start</h2>

<p>The quickest way to start is to utilize the Katana executable to generate an application:</p>

<div class="highlight"><pre><span class="nv">$ </span>katana create app
<span class="nv">$ </span><span class="nb">cd </span>app
<span class="nv">$ </span>npm install
</pre></div>

<p>The app path is optional and is relative to current path.</p>

<p>Then you are ready to start the server:</p>

<div class="highlight"><pre><span class="nv">$ </span>node app
</pre></div>

<h3>
<a name="basic-application-layout-after-creation-will-look-like-this" class="anchor" href="#basic-application-layout-after-creation-will-look-like-this"><span class="octicon octicon-link"></span></a>Basic application layout after creation will look like this:</h3>

<pre><code>.
├── app.js
├── application
│   ├── config
│   │   ├── development
│   │   │   ├── application.js
│   │   │   ├── routing.js
│   │   │   └── stores.js
│   │   └── production
│   ├── controllers
│   │   └── home.js
│   ├── models
│   └── views
│       └── index.html
├── modules
├── public
│   ├── images
│   ├── scripts
│   └── css
└── temp
</code></pre>

<h2>
<a name="routing" class="anchor" href="#routing"><span class="octicon octicon-link"></span></a>Routing</h2>

<p>Classical routing is one the most powerful futures of Katana framework. It uses uri segments to determine the controller and action for a requested URI.<br>
So unlike in other Node.js framework you may just add controllers and actions without the need to create routing rules, but also let you write your own rules which may change the path.<br>
Without any rules, uri path will be treated as: http://katana:8000/<code>controller</code>/<code>action</code>/<code>arg1</code>/../<code>argN</code></p>

<p>So if uri path is: <code>http://katana:8000/account/login</code><br>
Then <code>controller=account</code> and <code>action=login</code>.</p>

<p>If there no uri segments then default path will be used, <code>home</code> as controller and <code>index</code> as action.</p>

<p>You can also rewrite path by set the routing rule, for example to view user profile:</p>

<div class="highlight"><pre><span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
  <span class="c1">// each request method may have it's own routes</span>
  <span class="nx">get</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">'user/:user_id'</span><span class="p">,</span> <span class="s1">'users/profile'</span><span class="p">]</span>
  <span class="p">]</span>

  <span class="c1">// also you can set routes for all methods</span>
  <span class="nx">all</span><span class="o">:</span> <span class="p">[</span>
    <span class="c1">// if routes will not match for requested method then will try this routes</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>

<p>or you may set request method as route prefix:</p>

<div class="highlight"><pre><span class="nx">routes</span><span class="o">:</span> <span class="p">[</span>
  <span class="p">[</span><span class="s1">'get user/:user_id'</span><span class="p">,</span> <span class="s1">'users/profile'</span><span class="p">],</span> <span class="c1">// will route this for get method</span>
  <span class="p">[</span><span class="s1">'* user/:user_id'</span><span class="p">,</span> <span class="s1">'users/profile'</span><span class="p">]</span> <span class="c1">// all methods</span>
  <span class="p">[</span><span class="s1">'user/:user_id'</span><span class="p">,</span> <span class="s1">'users/profile'</span><span class="p">]</span> <span class="c1">// if not set then will check all methods</span>
<span class="p">]</span>
</pre></div>

<p>This will set <code>controller=users</code> and <code>action=profile</code> and user_id will be available as <code>Request.params.user_id</code>.</p>

<p>Or you may pass this request to mvc module:</p>

<div class="highlight"><pre><span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">get</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">'user/:user_id'</span><span class="p">,</span> <span class="s1">'#auth/users/profile'</span><span class="p">]</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>

<p>The <code>#</code> symbol meen that this request will pass to <code>auth</code> module, <code>controller=users</code> and <code>action=profile</code>.</p>

<p>You could also set format for user_id like so:</p>

<div class="highlight"><pre><span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">get</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">'user/:user_id([0-9]+)'</span><span class="p">,</span> <span class="s1">'#auth/users/profile'</span><span class="p">]</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>

<p><code>!important:</code> mvc modules may have their own routing rules.</p>

<p>We may also have controllers in subdirectories. Just set the directory path in square brackets.<br>
For example there is an <code>users</code> controller in <code>controllers/api</code> directory. The routing will look like:</p>

<div class="highlight"><pre><span class="nx">routes</span><span class="o">:</span> <span class="p">[</span>
  <span class="p">[</span><span class="s1">'api/users/*'</span><span class="p">,</span> <span class="s1">'[api]/users/:1'</span><span class="p">]</span> <span class="c1">// the slash after closing ] is optional</span>
<span class="p">]</span>
</pre></div>

<p>RESTful routes:</p>

<div class="highlight"><pre>  <span class="nx">routes</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">'get api/:resource'</span><span class="p">,</span>          <span class="s1">'[api]:resource/index'</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">'get api/:resource/new'</span><span class="p">,</span>      <span class="s1">'[api]:resource/new'</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">'post api/:resource'</span><span class="p">,</span>         <span class="s1">'[api]:resource/create'</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">'get api/:resource/:id'</span><span class="p">,</span>      <span class="s1">'[api]:resource/show'</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">'get api/:resource/:id/edit'</span><span class="p">,</span> <span class="s1">'[api]:resource/edit'</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">'put api/:resource/:id'</span><span class="p">,</span>      <span class="s1">'[api]:resource/update'</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">'delete api/:resource/:id'</span><span class="p">,</span>   <span class="s1">'[api]:resource/remove'</span><span class="p">]</span>
  <span class="p">]</span>
</pre></div>

<p>This means in <code>api</code> directory you could have a controller for each resource with methods <code>index</code>, <code>new</code>, <code>create</code>, <code>show</code>, <code>edit</code>, <code>update</code> and <code>remove</code>.<br>
If you use such HTTP methods as <code>put</code> or <code>delete</code> you must have some middleware which will rewrite the method. You could install <a href="https://github.com/Shogun147/Katana-methodOverride">methodOverride</a> module with <code>katana module install methodOverride</code> command in your app root. Don't forget to enable it with <code>katana module enable methodOverride</code>.<br>
On the client side, set desired method in hidden field with <code>_method</code> name:</p>

<div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/api"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"_method"</span> <span class="na">value=</span><span class="s">"put"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>

<p>Field name could be changed in the main module file.</p>

<p>More examples:</p>

<div class="highlight"><pre><span class="p">[</span><span class="s1">'news/:category/rss.:format(xml|json)?'</span><span class="p">,</span> <span class="s1">'news/rss'</span><span class="p">]</span> <span class="nx">will</span> <span class="nx">allow</span><span class="o">:</span>
 <span class="nx">news</span><span class="o">/</span><span class="nx">any_category</span><span class="o">/</span><span class="nx">rss</span>
 <span class="nx">news</span><span class="o">/</span><span class="nx">any_category</span><span class="o">/</span><span class="nx">rss</span><span class="p">.</span><span class="nx">xml</span>
 <span class="nx">news</span><span class="o">/</span><span class="nx">any_category</span><span class="o">/</span><span class="nx">rss</span><span class="p">.</span><span class="nx">json</span>

 <span class="nx">and</span> <span class="nx">News</span> <span class="nx">controller</span><span class="o">:</span>

 <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
   <span class="nx">rss</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
     <span class="c1">// Now we can use Request.params.category and Request.params.format</span>
     <span class="kd">var</span> <span class="nx">format</span> <span class="o">=</span> <span class="nx">Request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">format</span> <span class="o">||</span> <span class="s1">'xml'</span><span class="p">;</span> <span class="c1">// default xml</span>

     <span class="p">...</span>
   <span class="p">}</span>
 <span class="p">}</span>
</pre></div>

<h2>
<a name="modules" class="anchor" href="#modules"><span class="octicon octicon-link"></span></a>Modules</h2>

<p>In Katana modules can be used as mvc part or your application or as middleware.</p>

<p>For mvc modules you can use routing the same way as for main mvc.<br>
Also you can run them as widgets by calling run method: </p>

<div class="highlight"><pre><span class="nx">Module</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">).</span><span class="nx">run</span><span class="p">(</span><span class="s1">'users/list'</span><span class="p">);</span>
</pre></div>

<p>This will run <code>list</code> action of <code>users</code> controller from <code>auth</code> module.</p>

<p>Middleware modules can listen specific application events and interact as they need.</p>

<p>For example auth module can look like this:</p>

<div class="highlight"><pre><span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Model</span><span class="p">(</span><span class="s1">'auth:user'</span><span class="p">);</span> <span class="c1">// get user model of auth module</span>

<span class="c1">// listen new request event</span>
<span class="nx">App</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'request'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Request</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="nx">Request</span><span class="p">.</span><span class="nx">session</span><span class="p">);</span>

  <span class="nx">callback</span><span class="p">();</span> <span class="c1">// callback when we're done here, required for application to continue</span>
<span class="p">});</span>
</pre></div>

<p>and then in our controller we can access user object as <code>Request.user</code>.</p>

<h3>
<a name="sharing-modules" class="anchor" href="#sharing-modules"><span class="octicon octicon-link"></span></a>Sharing modules</h3>

<p><a href="https://github.com/Shogun147/Katana">Katana</a> comes with an basic modules sharing system which allow to download public modules and install them for application.</p>

<p>Katana binary has few new commands for interacting with modules:</p>

<ul>
<li>
<code>katana modules</code> - list all available modules.</li>
<li>
<code>katana module search &lt;str&gt;</code> - search modules that contain <code>str</code> in name or description.</li>
<li>
<code>katana module update</code> - update modules list and their info.</li>
<li>
<p><code>katana module install &lt;name&gt; [url]</code> - install or reinstall app module.</p>

<ul>
<li>
<code>name</code> or <code>name@version</code> - module name</li>
<li>
<code>url</code> or <code>username:repository</code> or <code>username:repository@version</code> - optional url or github username:repository combination.</li>
</ul>
<p>If only <code>name</code> is provided then download url will be builded from module data contained in modules registry file. The name could also be followed by an version tag.<br>
If second argument is an url then module will be downloaded from that url.<br>
If second argument is an combination of <code>username:repository@version</code> then the url will be: <code>https://github.com/:username/:repository/tarball/:version</code>.<br>
If no <code>version</code> provided then requested one will be last available version for module in registry. If no valid version will be detected then <code>master</code> brunch will be requested.<br>
For custom download url modules still must be gzipped tarballs.<br>
Examples of install:</p>

<ul>
<li><code>katana module install auth</code></li>
<li><code>katana module install auth@0.1.0</code></li>
<li><code>katana module install auth Shogun147:Katana-auth</code></li>
<li><code>katana module install auth Shogun147:Katana-auth@0.1.0</code></li>
<li><code>katana module install auth https://github.com/Shogun147/Katana-auth/tarball/master</code></li>
<li><code>katana module install auth http://my-site.com/downloads/module/v1.0.5</code></li>
</ul>
</li>
<li><p><code>katana module uninstall &lt;name&gt;</code> - uninstall and remove module</p></li>
<li><p><code>katana module enable &lt;name&gt;</code> - enable module</p></li>
<li><p><code>katana module disable &lt;name&gt;</code> - disable module</p></li>
</ul><p>For each of this actions [<code>install</code>, <code>uninstall</code>, <code>enable</code>, <code>disable</code>] modules could have their hooks which would be called. The hooks are stored in hooks directory of module.<br>
The hooks are useful when there is a need to do something unique on this actions. For ex the <code>install</code> hook (modules/:name/hooks/install.js) could create new tables in the database or copy modules assets to public directory…</p>

<p>The module registry is downloaded from <code>https://raw.github.com/Shogun147/Katana/master/modules.json</code>. To add new modules to the list just fork this file and send an pull request. This will make your module listed on <code>katana modules</code> command and on search.</p>

<h2>
<a name="controllers" class="anchor" href="#controllers"><span class="octicon octicon-link"></span></a>Controllers</h2>

<p>Controllers are almost most important part of any application, they handle incoming requests and send responses.</p>

<p>A simple controller looks like this:</p>

<div class="highlight"><pre><span class="c1">// define our controller Class</span>
<span class="nx">Class</span><span class="p">(</span><span class="s1">'Home_Controller'</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">isa</span><span class="o">:</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Controller</span><span class="p">,</span> <span class="c1">// extend Katana Core Controller</span>

  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'Hello World!'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Home_Controller</span><span class="p">;</span>

<span class="c1">// to not expose this class as a global, create it as anonymous</span>
<span class="kd">var</span> <span class="nx">HomeController</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">({</span> <span class="p">...</span> <span class="p">});</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HomeController</span><span class="p">;</span>

</pre></div>

<p>And now we can access this <code>index</code> action by opening http://katana:8000/, without any uri path this will use default controller and action from config which are <code>home</code> and <code>index</code>. Also we can access them directly by opening http://katana:8000/<code>home</code>/ with <code>index</code> as default action or http://katana:8000/<code>home</code>/<code>index</code>.</p>

<h3>
<a name="hooks" class="anchor" href="#hooks"><span class="octicon octicon-link"></span></a>Hooks</h3>

<p>Due the power of Joose <a href="http://joose.github.com/Joose/doc/html/Joose/Manual/MethodModifiers.html">Method Modifiers</a> (<code>before</code>, <code>after</code>, <code>override</code> and <code>around</code>) we may change the way class methods are called, actions that may happen before or after method call or even modify results that they could return.</p>

<p>For example let's restrict index method only for logged in users:</p>

<div class="highlight"><pre><span class="nx">Class</span><span class="p">(</span><span class="s1">'Home_Controller'</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">isa</span><span class="o">:</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Controller</span><span class="p">,</span>

  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'Hello World!'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">around</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// the same name for the method we want to wrap</span>
    <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">Request</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>

      <span class="c1">// if the user is not logged in then redirect to login page</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">User</span><span class="p">.</span><span class="nx">logged_in</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Request</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// else we call original method</span>
      <span class="nx">method</span><span class="p">(</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">Request</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p>The <code>call</code> modifier allow as to use regular expressions and apply that hook to all methods that matches the condition.</p>

<p>For example let's restrict access for all methods:</p>

<div class="highlight"><pre><span class="nx">Class</span><span class="p">(</span><span class="s1">'Home_Controller'</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">isa</span><span class="o">:</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Controller</span><span class="p">,</span>

  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'Hello World!'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">call</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// use regexp instead of methods name</span>
    <span class="c1">// this will apply to all controller methods calls</span>
   <span class="s1">'.*'</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">Request</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>

      <span class="c1">// if the user is not logged in then redirect to login page</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">User</span><span class="p">.</span><span class="nx">logged_in</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Request</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// else we call original method</span>
      <span class="nx">method</span><span class="p">(</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">Request</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<h2>
<a name="models" class="anchor" href="#models"><span class="octicon octicon-link"></span></a>Models</h2>

<p>Katana did not limit the developer to define a model in some way or to use a specific module. It just autoload all from the models directory of application or a module and store them in a local registry.</p>

<p>You can access them like this:<br></p>

<div class="highlight"><pre><span class="kd">var</span> <span class="nx">News</span> <span class="o">=</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Model</span><span class="p">(</span><span class="s1">'news'</span><span class="p">);</span> <span class="c1">// get model object</span>
</pre></div>

<p>To get a model from module you need to separate module name and model path with colon <code>:</code>, for example to get <code>user</code> model of <code>auth</code> module call: <code>App.Model('auth:user')</code>.</p>

<p>Model file can look like this:</p>

<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Mongoose</span> <span class="o">=</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Store</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">);</span> <span class="c1">// get mongoose connection, look at stores config file</span>
<span class="kd">var</span> <span class="nx">Schema</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">).</span><span class="nx">Schema</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Schema</span><span class="p">({</span>
  <span class="nx">username</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="nx">password</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="nx">email</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="nx">signed_at</span><span class="o">:</span> <span class="nb">Date</span><span class="p">,</span>
  <span class="nx">roles</span><span class="o">:</span> <span class="p">[</span><span class="s1">'user'</span><span class="p">,</span> <span class="s1">'moderator'</span><span class="p">,</span> <span class="s1">'administrator'</span><span class="p">]</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'User'</span><span class="p">,</span> <span class="nx">User</span><span class="p">);</span>
</pre></div>

<h2>
<a name="views" class="anchor" href="#views"><span class="octicon octicon-link"></span></a>Views</h2>

<p>To render a view you can use a few methods:</p>

<div class="highlight"><pre><span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="nx">App</span><span class="p">.</span><span class="nx">View</span><span class="p">;</span>

<span class="nx">Class</span><span class="p">(</span><span class="s1">'Home_Controller'</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">isa</span><span class="o">:</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Controller</span><span class="p">,</span>

  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// directly render and send a view content</span>
      <span class="nx">Response</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Hello World'</span> <span class="p">});</span> <span class="c1">// this will render index.html file from views</span>

      <span class="c1">// get rendered content</span>
      <span class="nx">View</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Hello World'</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// and latter send response</span>
        <span class="nx">Response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="c1">// render a view from module</span>
      <span class="nx">Users</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">users</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'Error! Blablabla'</span><span class="p">);</span> <span class="p">}</span>

        <span class="c1">// again module name separated by colon, and then path to the view</span>
        <span class="nx">View</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'auth:list'</span><span class="p">,</span> <span class="nx">users</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">Response</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">users</span><span class="o">:</span> <span class="nx">list</span> <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p>Controllers can also have their global data, which will be passed for the this.render calls:</p>

<div class="highlight"><pre><span class="nx">Class</span><span class="p">(</span><span class="s1">'Home_Controller'</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">isa</span><span class="o">:</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Controller</span><span class="p">,</span>

  <span class="nx">have</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// set global controller data</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">title</span><span class="o">:</span> <span class="s1">'This is title for all pages for this controller'</span><span class="p">,</span>
      <span class="nx">total_requests</span><span class="o">:</span> <span class="mi">0</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// you can also set global controller data from actions</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'copyright'</span><span class="p">,</span> <span class="s1">'blablabla'</span><span class="p">);</span>
      <span class="c1">// or</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">total_requests</span><span class="o">++</span><span class="p">;</span>

      <span class="c1">// by render the view with this.render method, the controller data will pass to this view</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// &lt;?-title?&gt;, &lt;?-total_requests?&gt;</span>

      <span class="c1">// we may also rewrite globals by set them on render</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'This is rewritted title'</span><span class="p">,</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">'bar'</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<h2>
<a name="events" class="anchor" href="#events"><span class="octicon octicon-link"></span></a>Events</h2>

<p>Katana application emit specific events for different steps.
Few of them are available for middlewares, the others are for bootstrap control flow.</p>

<ul>
<li>
<code>run</code> - on app initialization, but after bootstrapping</li>
<li>
<code>ready</code> - app is ready and started listening requests</li>
<li>
<code>connection</code> - emits just after the server get a new http.request.
the listener will get 3 arguments:

<ul>
<li>
<code>request</code> is a <code>http.IncomingMessage</code>
</li>
<li>
<code>response</code> is a <code>http.ServerResponse</code>
</li>
<li>
<code>next</code> callback so app flow will continue. If is not called then we must send response manually, also no other listeners or controller methods will be runned.</li>
</ul>
</li>
<li>
<code>request</code> - emits after request route is resolve and request data is prepared

<ul>
<li>
<code>request</code> is a <code>Katana.Core.Request</code>
</li>
<li>
<code>response</code> is a <code>Katana.Core.Response</code>
</li>
<li>
<code>next</code> callback
<code>request</code> and <code>response</code> in and after this event are the same as controller methods gets as arguments.</li>
</ul>
</li>
</ul><p>This events could be used to write some middlewares, same as in Express framework.</p>

<div class="highlight"><pre><span class="c1">// in express</span>
<span class="nx">App</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="c1">// in katana</span>
<span class="nx">App</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'request'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">uri</span><span class="p">);</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">})</span>
</pre></div>

<p>For example, <code>auth</code> module can listen <code>request</code> event to assign a user model for request (see Modules).</p>

<p>Or a <code>chat</code> module which need application server to create a socket.io server.</p>

<div class="highlight"><pre><span class="kd">var</span> <span class="nx">socket_io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'socket.io'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">io</span><span class="p">;</span>

<span class="c1">// waiting app ready</span>
<span class="nx">App</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'ready'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">io</span> <span class="o">=</span> <span class="nx">socket_io</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">App</span><span class="p">.</span><span class="nx">server</span><span class="p">);</span>

  <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'connection'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// …</span>
  <span class="p">});</span>

  <span class="nx">callback</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>

<h2>
<a name="sessions" class="anchor" href="#sessions"><span class="octicon octicon-link"></span></a>Sessions</h2>

<p>Katana has build in module for supporting sessions.
This gives you a way to associate data with each particular visitor of your app and have that data persist between requests.</p>

<h3>
<a name="data-stores" class="anchor" href="#data-stores"><span class="octicon octicon-link"></span></a>Data stores</h3>

<p>For now Katana support only 2 session data stores (more to come):</p>

<ul>
<li><p><strong>Memory</strong> (by default): useful for development. Session data is saved in memory at worker-process level, which means this will not work with cluster. Also, all sessions disappear when app is restarted.</p></li>
<li><p><strong>Redis</strong>: Sessions are saved in a redis noSQL database and persist across app restarts. Requires a Redis server or clusters.</p></li>
</ul><h3>
<a name="using-sessions" class="anchor" href="#using-sessions"><span class="octicon octicon-link"></span></a>Using sessions</h3>

<p>First of all you need to enable sessions in application config file.
The default session config look like this:</p>

<div class="highlight"><pre><span class="nx">session</span><span class="o">:</span> <span class="p">{</span>
  <span class="c1">// enable or disable session support</span>
  <span class="nx">enabled</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>

  <span class="c1">// session identifier name for cookie of</span>
  <span class="nx">key_name</span><span class="o">:</span> <span class="s1">'session_id'</span><span class="p">,</span>

  <span class="c1">// session id length</span>
  <span class="nx">key_length</span><span class="o">:</span> <span class="mi">32</span><span class="p">,</span>

  <span class="c1">// lifetime before delete inactive session</span>
  <span class="nx">lifetime</span><span class="o">:</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">,</span>

  <span class="c1">// session store, one from config/stores.js</span>
  <span class="nx">store</span><span class="o">:</span> <span class="s1">'redis'</span><span class="p">,</span>

  <span class="c1">// default data for new sessions</span>
  <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>

  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Once you enable sessions, the session object will be assigned to each request and data will be loaded automatically from the session store.
Then this object could be accessed as <code>Request.session</code>.
For now available public methods are <code>set</code>, <code>get</code> and <code>remove</code>.</p>

<p>Example counter of user requests:</p>

<div class="highlight"><pre><span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Session</span> <span class="o">=</span> <span class="nx">Request</span><span class="p">.</span><span class="nx">session</span><span class="p">;</span>

  <span class="c1">// get current requests count, default 0</span>
  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'requests'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="nx">counter</span><span class="o">++</span><span class="p">;</span>

  <span class="c1">// set new value</span>
  <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'requests'</span><span class="p">,</span> <span class="nx">counter</span><span class="p">);</span>

  <span class="c1">// Session data will be automatically saved in store before sending response</span>
  <span class="c1">// Also will save session id in the cookie with key_name from config</span>
  <span class="nx">Response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'You have visited this page '</span><span class="o">+</span> <span class="nx">counter</span> <span class="o">+</span><span class="s1">' times'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<h2>
<a name="logging" class="anchor" href="#logging"><span class="octicon octicon-link"></span></a>Logging</h2>

<p>Katana uses <a href="https://github.com/flatiron/winston">winston</a> module to log.
Available as <code>App.Log</code> you could add more transports or options to it. Check official docs for this.</p>

<h2>
<a name="examples" class="anchor" href="#examples"><span class="octicon octicon-link"></span></a>Examples</h2>

<ul>
<li>
<a href="https://github.com/Shogun147/TodoMVC">TodoMVC</a> - AngularJS MVC app with RESTful API on backend</li>
<li>
<a href="https://github.com/Shogun147/Katana-ToDo">ToDo</a> - Simple todo application</li>
</ul><h2>
<a name="contributing" class="anchor" href="#contributing"><span class="octicon octicon-link"></span></a>Contributing</h2>

<p>Anyone interested or who like the framework idea can contribute by sending new ideas, issues or pull requests. Any help would be appreciated.</p>

<h2>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h2>

<p>The MIT License</p>

<p>Copyright © 2013 D.G. Shogun <a href="mailto:Shogun147@gmail.com">Shogun147@gmail.com</a></p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/Shogun147/Katana/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/Shogun147/Katana/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/Shogun147/Katana"></a> is maintained by <a href="https://github.com/Shogun147">Shogun147</a>.</p>

          <p>This page was generated by <a href="pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("Katana nodejs node.js framework router modules mvc hmvc controllers async");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>